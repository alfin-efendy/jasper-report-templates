name: Jasper Report Deploy to Object Storage

on:
  workflow_run:
    workflows:
      - Jasper Report Test
    types:
      - completed
  workflow_dispatch:

env:
  STORAGE_PROVIDER: ${{ vars.STORAGE_PROVIDER || 'r2' }}
  STORAGE_PREFIX: ${{ vars.STORAGE_PREFIX || 'jasper-report-templates' }}
  STORAGE_REGION: ${{ vars.STORAGE_REGION || 'us-east-1' }}

jobs:
  deploy:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master'
      )
    runs-on: ubuntu-latest
    environment: live

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate storage provider
        run: |
          case "$STORAGE_PROVIDER" in
            r2|s3|gcs)
              echo "Using storage provider: $STORAGE_PROVIDER"
              ;;
            *)
              echo "Invalid STORAGE_PROVIDER: $STORAGE_PROVIDER"
              echo "Supported values: r2, s3, gcs"
              exit 1
              ;;
          esac

      - name: Upload to Cloudflare R2
        if: env.STORAGE_PROVIDER == 'r2'
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          r2-bucket: ${{ vars.STORAGE_BUCKET || vars.BUCKET }}
          source-dir: templates
          destination-dir: ${{ env.STORAGE_PREFIX }}/templates
          max-retries: 5

      - name: Configure AWS S3 credentials
        if: env.STORAGE_PROVIDER == 's3'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: ${{ env.STORAGE_REGION }}

      - name: Upload to AWS S3
        if: env.STORAGE_PROVIDER == 's3'
        env:
          STORAGE_BUCKET: ${{ vars.STORAGE_BUCKET || vars.BUCKET }}
        run: |
          if [ -z "$STORAGE_BUCKET" ]; then
            echo "STORAGE_BUCKET variable is required"
            exit 1
          fi

          aws s3 sync templates "s3://${STORAGE_BUCKET}/${STORAGE_PREFIX}/templates"
          echo "Upload completed to S3 bucket ${STORAGE_BUCKET}"

      - name: Authenticate to Google Cloud
        if: env.STORAGE_PROVIDER == 'gcs'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud SDK
        if: env.STORAGE_PROVIDER == 'gcs'
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to Google Cloud Storage
        if: env.STORAGE_PROVIDER == 'gcs'
        env:
          STORAGE_BUCKET: ${{ vars.STORAGE_BUCKET }}
        run: |
          if [ -z "$STORAGE_BUCKET" ]; then
            echo "STORAGE_BUCKET variable is required"
            exit 1
          fi

          gsutil -m rsync -r templates "gs://${STORAGE_BUCKET}/${STORAGE_PREFIX}/templates"
          echo "Upload completed to GCS bucket ${STORAGE_BUCKET}"
